<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>ClickHouse 入门笔记 | Runner的小站</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ClickHouse是一个用于联机分析(OLAP)的列式数据库管理系统(DBMS) 版本 文章使用版本 docker pull yandex/clickhouse-server:19.15.3.6 SQL支持 支持的查询包括 GROUP BY，ORDER BY，IN，JOIN以及非相关子查询。 不支持窗口函数和相关子查询。 支持近似计算 用于近似计算的各类聚合函数，如：distinct value">
<meta name="keywords" content="clickhouse,OLAP">
<meta property="og:type" content="article">
<meta property="og:title" content="ClickHouse 入门笔记">
<meta property="og:url" content="http://airzhe.github.io/2019/12/clickhouse/index.html">
<meta property="og:site_name" content="Runner的小站">
<meta property="og:description" content="ClickHouse是一个用于联机分析(OLAP)的列式数据库管理系统(DBMS) 版本 文章使用版本 docker pull yandex/clickhouse-server:19.15.3.6 SQL支持 支持的查询包括 GROUP BY，ORDER BY，IN，JOIN以及非相关子查询。 不支持窗口函数和相关子查询。 支持近似计算 用于近似计算的各类聚合函数，如：distinct value">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://airzhe.github.io/img/clickhouse/1.png">
<meta property="og:updated_time" content="2021-02-26T03:46:31.363Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ClickHouse 入门笔记">
<meta name="twitter:description" content="ClickHouse是一个用于联机分析(OLAP)的列式数据库管理系统(DBMS) 版本 文章使用版本 docker pull yandex/clickhouse-server:19.15.3.6 SQL支持 支持的查询包括 GROUP BY，ORDER BY，IN，JOIN以及非相关子查询。 不支持窗口函数和相关子查询。 支持近似计算 用于近似计算的各类聚合函数，如：distinct value">
<meta name="twitter:image" content="http://airzhe.github.io/img/clickhouse/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Runner的小站" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Runner的小站</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://airzhe.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-clickhouse" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/clickhouse/" class="article-date">
  <time datetime="2019-12-16T14:22:10.000Z" itemprop="datePublished">2019-12-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ClickHouse 入门笔记
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ClickHouse是一个用于联机分析(OLAP)的列式数据库管理系统(DBMS)</p>
<p><strong>版本</strong></p>
<p>文章使用版本 <code>docker pull yandex/clickhouse-server:19.15.3.6</code></p>
<p><strong>SQL支持</strong></p>
<p>支持的查询包括 GROUP BY，ORDER BY，IN，JOIN以及非相关子查询。 不支持窗口函数和相关子查询。</p>
<p><strong>支持近似计算</strong></p>
<p>用于近似计算的各类聚合函数，如：distinct values, medians(中位数), quantiles(分位数)</p>
<p><strong>吞吐量</strong></p>
<p>ClickHouse可以在单个服务器上每秒处理数百个查询（在最佳的情况下最多可以处理数千个），建议每秒最多查询100次。有一种流行的观点认为，想要有效的计算统计数据，必须要聚合数据，因为聚合将降低数据量。</p>
<p><strong>访问控制</strong></p>
<p>ClickHouse包含访问控制配置，它们位于<code>users.xml</code>文件中(与’config.xml’同目录)。 默认情况下，允许从任何地方使用默认的‘default’用户无密码的访问ClickHouse。</p>
<p>默认情况下它使用‘default’用户无密码的与localhost:9000服务建立连接。 客户端也可以用于连接远程服务，例如：<code>clickhouse-client --host=example.com</code></p>
<p><strong>时区设置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed &quot;144 i&lt;timezone&gt;Asia/Shanghai&lt;/timezone&gt;&quot; -i /etc/clickhouse-server/config.xml</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p><strong>交互方式</strong></p>
<p>客户端可以选择使用交互式与非交互式两种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE test (</span><br><span class="line">         created_date Date DEFAULT today(),  </span><br><span class="line">         created_at DateTime DEFAULT now(), </span><br><span class="line">        `id` UInt16,</span><br><span class="line">        `name` String</span><br><span class="line">) ENGINE = MergeTree(created_date, created_at, 8192);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;_EOF | clickhouse-client --database=default --query=&quot;INSERT INTO test FORMAT CSV&quot;;</span><br><span class="line">&apos;2016-08-14&apos;,&apos;2016-08-14 00:00:00&apos;,3, &apos;some text&apos;,</span><br><span class="line">&apos;2016-08-14&apos;,&apos;2016-08-14 00:00:01&apos;,4, &apos;some text&apos;</span><br><span class="line">_EOF</span><br></pre></td></tr></table></figure>
<p>可以指定 <code>\G</code> 来替代分号或者在分号后面，这表示 <code>Vertical</code> 的格式。在这种格式下，每一个值都会打印在不同的行中，这种方式对于宽表来说很方便。这个不常见的特性是为了兼容 MySQL 命令而加的。</p>
<p><strong>命令行参数</strong></p>
<p><a href="https://clickhouse.yandex/docs/zh/interfaces/cli/#ming-ling-xing-can-shu" target="_blank" rel="noopener">https://clickhouse.yandex/docs/zh/interfaces/cli/#ming-ling-xing-can-shu</a></p>
<p><strong>输入输出格式</strong></p>
<p>支持 json、csv 等多种格式 <a href="https://clickhouse.yandex/docs/zh/interfaces/formats/" target="_blank" rel="noopener">https://clickhouse.yandex/docs/zh/interfaces/formats/</a></p>
<p><strong>mysql 引擎</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE mysql_db ENGINE = MySQL(&apos;172.16.200.10:3306&apos;, &apos;test&apos;, &apos;root&apos;, &apos;passwd&apos;)</span><br></pre></td></tr></table></figure>
<p><strong>mergeTree 引擎</strong></p>
<p>使用新的ClickHouse自定义分区，不需要创建单独的日期列即可将MySQL中的表映射到ClickHouse中的相​​同表结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE wikistat</span><br><span class="line">(</span><br><span class="line">    id bigint,</span><br><span class="line">    dt DateTime,</span><br><span class="line">    project String,</span><br><span class="line">    subproject String,</span><br><span class="line">    path String,</span><br><span class="line">    hits UInt64,</span><br><span class="line">    size UInt64</span><br><span class="line">)</span><br><span class="line">ENGINE = MergeTree</span><br><span class="line">PARTITION BY toYYYYMMDD(dt)</span><br><span class="line">ORDER BY dt</span><br></pre></td></tr></table></figure>
<p><strong>ReplacingMergeTree 引擎</strong> (按主键进行合并)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE mergetree</span><br><span class="line">(</span><br><span class="line">    `msg_id` UInt64,</span><br><span class="line">    `msg_type` String,</span><br><span class="line">    `sync_time` DateTime DEFAULT now()</span><br><span class="line">)</span><br><span class="line">ENGINE = ReplacingMergeTree </span><br><span class="line">PARTITION BY toYYYYMMDD(sync_time)</span><br><span class="line">ORDER BY msg_id;</span><br><span class="line"># 插入数据</span><br><span class="line">insert into mergetree(msg_id,msg_type) values(1,&apos;aa&apos;) ;</span><br><span class="line"># 强制合并</span><br><span class="line">optimize table mergetree final;</span><br></pre></td></tr></table></figure></p>
<p><strong>SummingMergeTree</strong> (按主键合并，SummingMergeTree(a) a求和)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE smt_tab(date Date,id UInt8,name String,a UInt16) ENGINE=SummingMergeTree(a) PARTITION BY date ORDER BY (id,name) SAMPLE BY name</span><br><span class="line">#插入数据</span><br><span class="line">insert into smt_tab (date,id,name,a) values (&apos;2019-12-12&apos;,1,&apos;Jason&apos;,1)</span><br><span class="line">insert into smt_tab (date,id,name,a) values (&apos;2019-12-12&apos;,1,&apos;Jason&apos;,2)</span><br><span class="line">insert into smt_tab (date,id,name,a) values (&apos;2019-12-12&apos;,1,&apos;Jason&apos;,3)</span><br><span class="line">#结果只有一条，a列求和</span><br></pre></td></tr></table></figure></p>
<p><strong>JSON 函数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#pay_data 是否有 appId 下标</span><br><span class="line">select visitParamHas(pay_data,&apos;appId&apos;) from `order` limit 1;</span><br><span class="line">#获取appId值</span><br><span class="line">select visitParamExtractRaw(pay_data,&apos;appId&apos;) from `order` limit 1;</span><br><span class="line">#获取值</span><br><span class="line">SELECT visitParamExtractString(return_data, &apos;body&apos;) FROM order_behavior_log LIMIT 10;</span><br></pre></td></tr></table></figure>
<p><a href="https://clickhouse.yandex/docs/zh/query_language/functions/json_functions/" target="_blank" rel="noopener">https://clickhouse.yandex/docs/zh/query_language/functions/json_functions/</a></p>
<p><strong>数据备份</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client -d default --query=&quot;show create table ontime&quot;</span><br><span class="line">clickhouse-client -d default -f CSV --query=&quot;select * from ontime limit 1&quot; &gt;/var/lib/clickhouse/a.csv</span><br></pre></td></tr></table></figure>
<p><strong>使用 mysql 和 clickhouse mysql 引擎，以及 clickhouse 直接查询对比:</strong><br><img src="/img/clickhouse/1.png" alt="1.png"></p>
<p>存档到ClickHouse允许您保留旧数据并将其用于报告</p>
<p><strong>LowCardinality 类型</strong> （对字符串做数字字典）</p>
<p>城市名称相对较短，航班号甚至更短。在较长的字符串上，LowCardinality的影响可能会更加明显。</p>
<p>值得一提的是，还有一种用字典编码字符串的可能性：<a href="https://clickhouse.yandex/docs/en/data_types/enum/" target="_blank" rel="noopener">Enums</a>。ClickHouse完美支持枚举。从存储的角度来看，它可能甚至更有效率，因为枚举值存储在表定义上而不是存储在单独的数据文件中。枚举适用于静态字典。但是，如果插入了原始枚举之外的值，ClickHouse将引发异常。枚举值集中的每个更改都需要ALTER TABLE，这可能会带来很多麻烦。LowCardinality在这方面要灵活得多。</p>
<p><strong>实时视图</strong></p>
<p>将实时视图表与真实数据集一起使用 live view , 相比普通 view 除了实时还多了缓存</p>
<p><strong>命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">detach database payemnt #删除mysql引擎库</span><br><span class="line">alter table cpu update usage_user = 888 where usage_user=18 #update</span><br><span class="line">alter table cpu delete where usage_user = 888 #delete</span><br><span class="line">alter table user_behavior add column `operation` String after service; #add column</span><br><span class="line">alter table user_behavior drop column operator; #drop column</span><br><span class="line">rename table system_msg to system_msg_old</span><br></pre></td></tr></table></figure>
<p><strong>web 客户端tabix</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8080:80 spoonest/clickhouse-tabix-web-client</span><br></pre></td></tr></table></figure>
<p><strong>查询示例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#执行时间分位数查询</span><br><span class="line">SELECT</span><br><span class="line">    created_date,</span><br><span class="line">    quantile(0.999)(toFloat64(execute_mic_time))</span><br><span class="line">FROM order_behavior_log</span><br><span class="line">WHERE (created_date &gt; &apos;2019-11-28 12:00:00&apos;) AND (created_date &lt; &apos;2019-11-28 12:01:00&apos;)</span><br><span class="line">GROUP BY created_date</span><br><span class="line">ORDER BY created_date ASC</span><br><span class="line"></span><br><span class="line">#最近7天</span><br><span class="line">SELECT</span><br><span class="line">    toUnixTimestamp(toStartOfDay(created_date)) AS time,</span><br><span class="line">    max(created_date),</span><br><span class="line">    sum(total_fee) / 100</span><br><span class="line">FROM order_behavior_log</span><br><span class="line">WHERE (created_date &lt;= now()) AND (created_date &gt;= (toDate(now()) - 7)) AND (state = 3)</span><br><span class="line">GROUP BY time</span><br><span class="line">ORDER BY time ASC</span><br><span class="line"></span><br><span class="line">#10月份销售额</span><br><span class="line">select sum(total_fee)/100 from order_behavior_log where toDate(created_date) &gt;= &apos;2019-10-01&apos; and toDate(created_date) &lt;=&apos;2019-10-31&apos; and state = 3</span><br></pre></td></tr></table></figure>
<p><strong>系统查询</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#查看列大小</span><br><span class="line">SELECT column, any(type), </span><br><span class="line">        sum(column_data_compressed_bytes) compressed, </span><br><span class="line">        sum(column_data_uncompressed_bytes) uncompressed, </span><br><span class="line">        sum(rows)</span><br><span class="line">    FROM system.parts_columns </span><br><span class="line">    WHERE (table = &apos;ontime&apos;) AND active AND (column LIKE &apos;%CityName&apos;)</span><br><span class="line">    GROUP BY column</span><br><span class="line">    ORDER BY column ASC</span><br><span class="line">    </span><br><span class="line">#查看表大小，也可以到data 目录下执行 `du -h --max-depth=1`</span><br><span class="line">SELECT </span><br><span class="line">    table, </span><br><span class="line">    sum(rows), </span><br><span class="line">    formatReadableSize(sum(data_compressed_bytes)) AS compressed_size, </span><br><span class="line">    formatReadableSize(sum(data_uncompressed_bytes)) AS uncompr</span><br><span class="line">FROM system.parts</span><br><span class="line">WHERE active AND (table LIKE &apos;order_behavior_log&apos;)</span><br><span class="line">GROUP BY table</span><br></pre></td></tr></table></figure>
<p><strong>产生date_time列</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat data.csv | awk -F &quot;,&quot; &apos;&#123;str=substr($NF,0,11);print $0&quot;,&quot;str&#125;&apos;</span><br><span class="line">#时间戳</span><br><span class="line">PARTITION BY toYYYYMMDD(toDateTime(create_date))</span><br></pre></td></tr></table></figure>
<p><strong>使用 mysql 函数将 mysql 数据导入clickhouse</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#方式一 (导入之前要先修改时区)</span><br><span class="line">CREATE TABLE order_behavior_log</span><br><span class="line">ENGINE = MergeTree</span><br><span class="line">PARTITION BY toYYYYMMDD(created_date)</span><br><span class="line">ORDER BY id AS</span><br><span class="line">SELECT *</span><br><span class="line">FROM mysql(&apos;172.16.200.40&apos;, &apos;soa_behavior&apos;, &apos;order_behavior_log&apos;, &apos;root&apos;, &apos;passwd&apos;)</span><br><span class="line"></span><br><span class="line">Ok.</span><br><span class="line"></span><br><span class="line">0 rows in set. Elapsed: 89.739 sec. Processed 7.38 million rows, 11.81 GB (82.25 thousand rows/s., 131.63 MB/s.)</span><br><span class="line"></span><br><span class="line">┌─count()─┐</span><br><span class="line">│ 7381387 │</span><br><span class="line">└─────────┘</span><br><span class="line"></span><br><span class="line">┌─table──────────────┬─sum(rows)─┬─compressed_size─┬─uncompr───┐</span><br><span class="line">│ order_behavior_log │   7381387 │ 4.72 GiB        │ 10.63 GiB │</span><br><span class="line">└────────────────────┴───────────┴─────────────────┴───────────┘</span><br><span class="line"></span><br><span class="line">#方式二增量</span><br><span class="line">INSERT INTO order_behavior_log SELECT *</span><br><span class="line">FROM mysql(&apos;172.16.200.40&apos;, &apos;soa_behavior&apos;, &apos;order_behavior_log&apos;, &apos;root&apos;, &apos;passwd&apos;)</span><br><span class="line">WHERE id &gt;</span><br><span class="line">(</span><br><span class="line">    SELECT max(id)</span><br><span class="line">    FROM order_behavior_log</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#使用非交互模式</span><br><span class="line">clickhouse-client --input_format_allow_errors_num=10 \</span><br><span class="line">--query=&quot;INSERT INTO bill SELECT * FROM url(&apos;http://ck.t1.apple.net/?database=default&amp;query=select%20*%20from%20bill&apos;, TabSeparated, &apos;created_date DateTime, wx_app_id String, mch_id String, order_id String, shop_order_id String, trade_type String, trade_status String, total_fee Float64, refund_id String, shop_refund_id String, refund_fee Float64, refund_status String, goods_name String, fees Float64, rates String, trade_no String, refund_no String&apos;)&quot;</span><br></pre></td></tr></table></figure>
<p><strong>使用 url 函数 clickhouseA 导入 clickhouseB</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#方式一 (导入之前要先修改时区)</span><br><span class="line">CREATE TABLE order_behavior_log</span><br><span class="line">ENGINE = MergeTree</span><br><span class="line">PARTITION BY toYYYYMMDD(created_date)</span><br><span class="line">ORDER BY id AS</span><br><span class="line">SELECT *</span><br><span class="line">FROM url(&apos;http://10.2.4.3:8123/?database=soa_behavior&amp;query=select%20*%20from%20order_behavior_log&apos;, TabSeparated, &apos;`id` Int64, `shop_order_id` Int64, `trade_no` Int64, `shop_id` Int32, `trace_id` String, `agg_platform` String, `deal_handler` String, `parameters` String, `total_fee` Int32, `state` Int8, `return_data` String, `execute_mic_time` String, `error_code` Int32, `error_msg` String, `created_at` Int32, `updated_at` Int32, `deleted_at` Nullable(Int32), `created_date` DateTime&apos;)</span><br><span class="line">LIMIT 3</span><br><span class="line"></span><br><span class="line">#方式二增量</span><br><span class="line">INSERT INTO order_behavior_log SELECT *</span><br><span class="line">FROM url(&apos;http://10.2.4.3:8123/?database=soa_behavior&amp;query=select%20*%20from%20order_behavior_log&apos;, TabSeparated, &apos;`id` Int64, `shop_order_id` Int64, `trade_no` Int64, `shop_id` Int32, `trace_id` String, `agg_platform` String, `deal_handler` String, `parameters` String, `total_fee` Int32, `state` Int8, `return_data` String, `execute_mic_time` String, `error_code` Int32, `error_msg` String, `created_at` Int32, `updated_at` Int32, `deleted_at` Nullable(Int32), `created_date` DateTime&apos;)</span><br><span class="line">LIMIT 3</span><br></pre></td></tr></table></figure>
<p><strong>clickhouse 查询远程数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 从api接口查询</span><br><span class="line">SELECT *</span><br><span class="line">FROM url(&apos;http://10.2.4.35:8123/?database=soa_behavior&amp;query=select%20*%20from%20order_behavior_log&amp;user=default&amp;password=MXtqOeQcX&apos;, TabSeparated, &apos;`id` Int64, `shop_order_id` Int64, `trade_no` Int64, `shop_id` Int32, `trace_id` String, `agg_platform` String, `deal_handler` String, `parameters` String, `total_fee` Int32, `state` Int8, `return_data` String, `execute_mic_time` String, `error_code` Int32, `error_msg` String, `created_at` Int32, `updated_at` Int32, `deleted_at` Nullable(Int32), `created_date` DateTime&apos;)</span><br><span class="line">LIMIT 3</span><br><span class="line"></span><br><span class="line"># 从远端mysql查询</span><br><span class="line">SELECT </span><br><span class="line">    data1, </span><br><span class="line">    COUNT(*)</span><br><span class="line">FROM mysql(&apos;172.16.200.4:3306&apos;, &apos;soa_behavior&apos;, &apos;order_behavior_log&apos;, &apos;root&apos;, &apos;passwd&apos;) </span><br><span class="line">GROUP BY data1</span><br></pre></td></tr></table></figure>
<p><strong>开启mysql客户端支持</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sed &quot;145 i&lt;mysql_port&gt;9004&lt;/mysql_port&gt;&quot; -i /etc/clickhouse-server/config.xml</span><br><span class="line"></span><br><span class="line">## 导入mysql数据</span><br><span class="line">mysql --protocol tcp -u default -h 10.42.0.76 -P 9004   &lt; /home/runner/work/clickhouse/clickhouse/tmp/sms_new_metrics.sql</span><br><span class="line"></span><br><span class="line">#查询</span><br><span class="line">SELECT (intDiv(toUInt32(created_at), 7200) * 7200) * 1000 as t, count(id) AS &quot;id&quot; FROM metrics WHERE  created_at BETWEEN  &apos;2020-03-01 00:00:00&apos;  AND  &apos;2020-06-04 15:59:59&apos;  GROUP BY t ORDER BY 1;</span><br></pre></td></tr></table></figure>
<p><strong>跳过错误</strong> (忽略csv标题行)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client --input_format_allow_errors_num=1 \</span><br><span class="line">--input_format_allow_errors_ratio=0.1 \</span><br><span class="line">--query=&quot;INSERT INTO bill SELECT *</span><br><span class="line">FROM url(&apos;http://payment-hotfix-duizhangdan.t1.apple.net/order/downloadbill?bill_date=20200106&amp;agg_platform=wx&apos;, CSV, &apos;created_date DateTime, wx_app_id String , mch_id String, order_id String , shop_order_id String, trade_type String, trade_status String, total_fee Float64 , refund_id String, shop_refund_id String ,refund_fee  Float64, refund_status String, goods_name String, fees Float64, rates String , trade_no String , refund_no String&apos;)&quot;</span><br></pre></td></tr></table></figure>
<p><strong>php 客户端</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#composer require smi2/phpclickhouse</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include(&apos;./vendor/autoload.php&apos;);</span><br><span class="line">$config = [</span><br><span class="line">    &apos;host&apos; =&gt; &apos;10.0.12.*&apos;,</span><br><span class="line">    &apos;port&apos; =&gt; &apos;8123&apos;,</span><br><span class="line">    &apos;username&apos; =&gt; &apos;default&apos;,</span><br><span class="line">    &apos;password&apos; =&gt; &apos;&apos;</span><br><span class="line">];</span><br><span class="line">$db = new ClickHouseDB\Client($config);</span><br><span class="line">$db-&gt;database(&apos;soa_behavior&apos;);</span><br><span class="line">$statement = $db-&gt;select(&apos;select * from order_behavior_log where id = 100&apos;);</span><br><span class="line">print_r($statement-&gt;rows());</span><br><span class="line"></span><br><span class="line">$statement = $db-&gt;write(&apos;alter table order_behavior_log update shop_id = 1 where id = 100&apos;);</span><br><span class="line">print_r($statement-&gt;info());</span><br></pre></td></tr></table></figure>
<p><strong>grafana查询</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    1574058600000 as t,</span><br><span class="line">    usage_user</span><br><span class="line">FROM $table</span><br><span class="line">WHERE $timeFilter</span><br><span class="line">ORDER BY t</span><br><span class="line"></span><br><span class="line">#查询最近7天数据</span><br><span class="line">SELECT</span><br><span class="line">    t,</span><br><span class="line">    groupArray((d,s)) AS groupArr</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">  SELECT </span><br><span class="line">      (intDiv(toUInt32(created_date), 86400) * 86400) * 1000 AS t,</span><br><span class="line">      toDate(created_date) AS d, </span><br><span class="line">      sum(total_fee) / 100 AS s</span><br><span class="line">  FROM $table</span><br><span class="line">  WHERE (created_date &lt; toDateTime($to)) AND (created_date &gt; (toDate($to) - 7)) AND (state = 3)</span><br><span class="line">  GROUP BY t,d</span><br><span class="line">  ORDER BY t ASC</span><br><span class="line">)</span><br><span class="line">GROUP BY t</span><br><span class="line">ORDER BY t </span><br><span class="line"></span><br><span class="line">#七日数据</span><br><span class="line">SELECT</span><br><span class="line">    t + 86400000 * 7,</span><br><span class="line">    st AS `七日`</span><br><span class="line">FROM</span><br><span class="line">(</span><br><span class="line">  SELECT</span><br><span class="line">     (intDiv(toUInt32(created_date), $interval) * $interval) * 1000 AS t,</span><br><span class="line">     sum(total_fee)/100 as st</span><br><span class="line">  FROM $table</span><br><span class="line">  WHERE </span><br><span class="line">      (created_date &gt; toDateTime($from - 86400*7)) AND (created_date &lt; toDateTime($to - 86400*7))</span><br><span class="line">      $conditionalTest(AND agg_platform IN ($agg_platform),$agg_platform) </span><br><span class="line">  Group by t</span><br><span class="line">  ORDER BY t</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">#世界地图</span><br><span class="line">CREATE TABLE `worldmap_latlng` (</span><br><span class="line">   created_date Date DEFAULT today(),  </span><br><span class="line">   created_at DateTime DEFAULT now(),    </span><br><span class="line">  `lat` Float32,</span><br><span class="line">  `lng` Float32,</span><br><span class="line">  `name` String,</span><br><span class="line">  `value` Int32</span><br><span class="line"> ) ENGINE = MergeTree(created_date, created_at, 8192);</span><br><span class="line"> </span><br><span class="line">INSERT INTO `worldmap_latlng`(`lat`, `lng`, `name`, `value`) VALUES (31.24916171,121.487899486, &apos;上海&apos;, 2)</span><br></pre></td></tr></table></figure>
<p><strong>高可用</strong></p>
<a href="/2020/06/clickhouse-ha/" title="clickhouse高可用集群搭建">clickhouse高可用集群搭建</a>
<p><strong>定时同步mysql</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* * * * * sh /root/sh/sync_soa_behavior.sh</span><br><span class="line">0 0 * * * sh /root/sh/sync_soa_behavior_del_today.sh</span><br><span class="line"></span><br><span class="line">[root@node-a001 sh]# cat sync_soa_behavior_del_today.sh</span><br><span class="line"></span><br><span class="line">docker exec clickhouse clickhouse-client --database=soa_behavior --query=&quot;alter table order_behavior_log delete where created_date &gt;= yesterday()&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node-a001 sh]# cat sync_soa_behavior.sh</span><br><span class="line"></span><br><span class="line">docker exec clickhouse clickhouse-client --database=soa_behavior --query=&quot;alter table order_behavior_log delete where created_date &gt;= toStartOfTenMinutes(now())&quot;</span><br><span class="line"></span><br><span class="line">sleep 5</span><br><span class="line"></span><br><span class="line">docker exec clickhouse clickhouse-client --database=soa_behavior --query=&quot;INSERT INTO order_behavior_log SELECT * FROM mysql(&apos;mysql.host&apos;, &apos;soa_behavior&apos;, &apos;order_behavior_log&apos;, &apos;username&apos;,&apos;password&apos;) WHERE id &gt;(SELECT max(id) FROM order_behavior_log)&quot;</span><br></pre></td></tr></table></figure></p>
<p><strong>抽样</strong><br>同时我们还可以通过 ClickHouse 的抽样功能来辅助降低引擎查询压力。这里需要注意的是，只有在创建表结构时开启抽样查询功能，才能执行抽样查询 SQL<br>那么如何开启抽样查询功能呢，其实很简单，比如我们想以 datetime 维度进程抽样展示，只要在您的建表语句中包含 SAMPLE BY intHash64(datetime) ，同时，在您的主键中，也就是 ORDER BY 里面，必须包含抽样的字段。完成的建表语句如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE soa.user_behavior</span><br><span class="line">(</span><br><span class="line">    `date` Date DEFAULT today(),</span><br><span class="line">    `datetime` DateTime DEFAULT now(),</span><br><span class="line">    `user` String,</span><br><span class="line">    `service` String,</span><br><span class="line">    `operation` String,</span><br><span class="line">    `content` String,</span><br><span class="line">    `extra` String,</span><br><span class="line">    `op_time` DateTime</span><br><span class="line">)</span><br><span class="line">ENGINE = ReplicatedMergeTree(&apos;/clickhouse/tables/&#123;layer&#125;-&#123;shard&#125;/user_behavior&apos;, &apos;&#123;replica&#125;&apos;)</span><br><span class="line">PARTITION BY date</span><br><span class="line">ORDER BY (date, user, intHash64(datetime))</span><br><span class="line">SAMPLE BY intHash64(datetime)</span><br><span class="line">SETTINGS index_granularity = 8192</span><br></pre></td></tr></table></figure></p>
<p><strong>grafana 7.0警报支持</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rm -rfv /var/lib/grafana/plugins/vertamedia-clickhouse/</span><br><span class="line">git clone https://github.com/Vertamedia/clickhouse-grafana /var/lib/grafana/plugins/vertamedia-clickhouse/</span><br><span class="line">echo &quot;[plugins]\nallow_loading_unsigned_plugins = vertamedia-clickhouse-datasource&quot; &gt;&gt; /etc/grafana/grafana.ini</span><br><span class="line">systemctl restart grafana</span><br><span class="line"></span><br><span class="line"># helm形式安装</span><br><span class="line">在 grafana 包 value.yaml 文件大概390行，添加：    </span><br><span class="line">allow_loading_unsigned_plugins: &quot;vertamedia-clickhouse-datasource&quot;</span><br></pre></td></tr></table></figure></p>
<p><strong>物化视图</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE MATERIALIZED VIEW mv_sms_year_month_cnt</span><br><span class="line">ENGINE = SummingMergeTree</span><br><span class="line">PARTITION BY year_month</span><br><span class="line">ORDER BY (year_month,channel) POPULATE AS</span><br><span class="line">SELECT</span><br><span class="line">    toYYYYMM(created_at) AS year_month,</span><br><span class="line">    channel,</span><br><span class="line">    count() AS cnt</span><br><span class="line">FROM sms_report</span><br><span class="line">GROUP BY</span><br><span class="line">    toYYYYMM(created_at),</span><br><span class="line">    channel</span><br></pre></td></tr></table></figure></p>
<p><strong>备份</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client --host=&quot;localhost&quot; --port=&quot;9000&quot; --user=&quot;default&quot; --password=&quot;*******&quot; --max_threads=&quot;1&quot;  --query=&quot;select * from biw.system_msg FORMAT CSV&quot;  &gt; /tmp/system_20200819.csv</span><br></pre></td></tr></table></figure></p>
<p><strong>参考：</strong></p>
<p><a href="https://clickhouse.yandex/docs/zh/" target="_blank" rel="noopener">https://clickhouse.yandex/docs/zh/</a><br><a href="https://www.altinity.com/blog/clickhouse-for-time-series" target="_blank" rel="noopener">https://www.altinity.com/blog/clickhouse-for-time-series</a><br><a href="https://clickhouse.yandex/docs/zh/getting_started/example_datasets/ontime/" target="_blank" rel="noopener">https://clickhouse.yandex/docs/zh/getting_started/example_datasets/ontime/</a><br><a href="https://www.altinity.com/blog/2018/2/12/aggregate-mysql-data-at-high-speed-with-clickhouse" target="_blank" rel="noopener">https://www.altinity.com/blog/2018/2/12/aggregate-mysql-data-at-high-speed-with-clickhouse</a><br><a href="https://developer.aliyun.com/article/739805" target="_blank" rel="noopener">https://developer.aliyun.com/article/739805</a><br><a href="https://altinity.com/blog/2019/12/28/creating-beautiful-grafana-dashboards-on-clickhouse-a-tutorial" target="_blank" rel="noopener">创建grafana面板</a></p>
<p>多分片多副本高可用<br><a href="https://clickhouse.yandex/docs/zh/operations/table_engines/distributed/" target="_blank" rel="noopener">https://clickhouse.yandex/docs/zh/operations/table_engines/distributed/</a><br><a href="http://sineyuan.github.io/post/clickhouse-docker-quick-start/" target="_blank" rel="noopener">http://sineyuan.github.io/post/clickhouse-docker-quick-start/</a><br><a href="https://www.cnblogs.com/freeweb/p/9352947.html" target="_blank" rel="noopener">https://www.cnblogs.com/freeweb/p/9352947.html</a><br><a href="https://www.jianshu.com/p/ab811cceb856" target="_blank" rel="noopener">https://www.jianshu.com/p/ab811cceb856</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://airzhe.github.io/2019/12/clickhouse/" data-id="ckmcwj5b4000j2vpbn7tmanjp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OLAP/">OLAP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/clickhouse/">clickhouse</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/01/awk/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          使用awk处理csv文件
        
      </div>
    </a>
  
  
    <a href="/2019/11/ldap-pbkdf2/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">迁移gogs用户到openldap</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/OLAP/">OLAP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/angular-js/">angular js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awk/">awk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clickhouse/">clickhouse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/consul/">consul</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/containerd/">containerd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/coredns/">coredns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/etcd/">etcd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gaea/">gaea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitrunner/">gitrunner</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go-mysql-elasticsearch/">go-mysql-elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/goalng/">goalng</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gogs/">gogs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grafana/">grafana</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/haproxy/">haproxy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/helm/">helm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/">jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k3s/">k3s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kube-adm/">kube-adm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ldap/">ldap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logrus/">logrus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/loki/">loki</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/machinery/">machinery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microk8s/">microk8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openldap/">openldap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openresty/">openresty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pbkdf2/">pbkdf2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pipeline/">pipeline</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/prometheus/">prometheus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/promtal/">promtal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shazam/">shazam</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcp-ip/">tcp/ip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vuejs/">vuejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webshell/">webshell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xorm/">xorm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中间件/">中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/延迟队列/">延迟队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/报警/">报警</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日志/">日志</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/监控/">监控</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/OLAP/" style="font-size: 10px;">OLAP</a> <a href="/tags/angular-js/" style="font-size: 10px;">angular js</a> <a href="/tags/awk/" style="font-size: 10px;">awk</a> <a href="/tags/clickhouse/" style="font-size: 15px;">clickhouse</a> <a href="/tags/consul/" style="font-size: 10px;">consul</a> <a href="/tags/containerd/" style="font-size: 10px;">containerd</a> <a href="/tags/coredns/" style="font-size: 10px;">coredns</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/etcd/" style="font-size: 10px;">etcd</a> <a href="/tags/gaea/" style="font-size: 10px;">gaea</a> <a href="/tags/gitrunner/" style="font-size: 10px;">gitrunner</a> <a href="/tags/go-mysql-elasticsearch/" style="font-size: 10px;">go-mysql-elasticsearch</a> <a href="/tags/goalng/" style="font-size: 10px;">goalng</a> <a href="/tags/gogs/" style="font-size: 10px;">gogs</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/grafana/" style="font-size: 17.5px;">grafana</a> <a href="/tags/haproxy/" style="font-size: 10px;">haproxy</a> <a href="/tags/helm/" style="font-size: 15px;">helm</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/jenkins/" style="font-size: 12.5px;">jenkins</a> <a href="/tags/k3s/" style="font-size: 10px;">k3s</a> <a href="/tags/k8s/" style="font-size: 20px;">k8s</a> <a href="/tags/kube-adm/" style="font-size: 10px;">kube-adm</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/ldap/" style="font-size: 10px;">ldap</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/logrus/" style="font-size: 10px;">logrus</a> <a href="/tags/loki/" style="font-size: 12.5px;">loki</a> <a href="/tags/machinery/" style="font-size: 10px;">machinery</a> <a href="/tags/microk8s/" style="font-size: 10px;">microk8s</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/openldap/" style="font-size: 10px;">openldap</a> <a href="/tags/openresty/" style="font-size: 10px;">openresty</a> <a href="/tags/pbkdf2/" style="font-size: 10px;">pbkdf2</a> <a href="/tags/pipeline/" style="font-size: 12.5px;">pipeline</a> <a href="/tags/prometheus/" style="font-size: 12.5px;">prometheus</a> <a href="/tags/promtal/" style="font-size: 12.5px;">promtal</a> <a href="/tags/shazam/" style="font-size: 10px;">shazam</a> <a href="/tags/tcp-ip/" style="font-size: 10px;">tcp/ip</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/vue/" style="font-size: 10px;">vue</a> <a href="/tags/vuejs/" style="font-size: 10px;">vuejs</a> <a href="/tags/webshell/" style="font-size: 12.5px;">webshell</a> <a href="/tags/xorm/" style="font-size: 10px;">xorm</a> <a href="/tags/中间件/" style="font-size: 10px;">中间件</a> <a href="/tags/延迟队列/" style="font-size: 10px;">延迟队列</a> <a href="/tags/报警/" style="font-size: 10px;">报警</a> <a href="/tags/日志/" style="font-size: 10px;">日志</a> <a href="/tags/监控/" style="font-size: 10px;">监控</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/golang-design-pattern/">Golang 设计模式&quot;</a>
          </li>
        
          <li>
            <a href="/2021/01/machinery/">machinery流程图与源码剖析</a>
          </li>
        
          <li>
            <a href="/2020/12/go-mysql-elasticsearch/">go-mysql-elasticsearch 源码解读</a>
          </li>
        
          <li>
            <a href="/2020/10/ldap/">ldap 常用命令</a>
          </li>
        
          <li>
            <a href="/2020/10/k3s/">K3S</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 air_zhe@163.com<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>